const NEWS_ARTICLES = {
    headline: [
        {
            id: 'headline_1',
            title: "Ape-palling Behavior! Lanky Kong's Summit Shenanigans Cause Diplomatic and Economic Crisis!",
            image: 'dk_crew.png',
            image_alt: "A formal diplomatic stage in chaos. A long-armed ape can be seen flying through the air like a deflating balloon while dignitaries flee in terror.",
            date: "OCTOBER 28, YEAR 42",
            author: "By The Daily Paradox Political Desk",
            content: `
The much-anticipated Democratic Summit ended in chaos and financial panic yesterday, not because of a political disagreement, but due to the "completely disgraceful" conduct of Lanky Kong, a representative of the DK Crew. During a photo opportunity with a high-profile president, Lanky Kong reportedly grabbed the dignitary, inflated himself to five times his normal size, and flew around the room "like the world's scariest whoopy cushion."

The incident sent the dignitary fleeing in terror and caused a severe diplomatic fallout for the DK Crew's leader, Donkey Kong. The political turmoil was matched by economic panic, as the Mushroom Kingdom's gold coin standard went into a two-hour freefall. Sources claim only a last-minute favor from Chancellor Toadsworth prevented a complete market collapse. The "Kremling Koin" is now trading at 4.5 times the value of the DK Crew's "Banana Bunch" currency.

The incident has created a deep schism within the normally tight-knit Kong family. Diddy Kong is reportedly motioning for Lanky's expulsion from the crew, a move supported by Candy Kong, once Lanky's staunchest advocate. Donkey Kong is said to be furious and has tasked his brother Chunky Kong with mediating the crisis. When reached for comment, Lanky Kong reportedly made a series of baffling jokes, indicating he does not grasp the severity of the situation.
            `,
            type: 'headline'
        }
    ],
    side_story: [
        {
            id: 'side_fawful_gala',
            title: "GALA OF GHOSTS! Castle Infiltration Ends in Bizarre Temporal Event, Loyalist Hero Presumed Dead!",
            image: 'newspaper_fawful_gala.png',
            image_alt: "A chaotic scene within a grand hall. A small, toad-like figure bravely faces a towering, god-like entity while other figures flee in terror.",
            date: "OCTOBER 27, YEAR 42",
            author: "By W.A.H. Media Collective",
            content: `
Fawful's 'Grand Gala' at the occupied Peach's Castle has become the epicenter of reality-bending chaos. Reports from the joint Koopa-Loyalist infiltration team, now confirmed by multiple sources, indicate that the powerful entity known as the 'God Toad' possesses the ability to manipulate time itself.

During a confrontation, the Loyalist hero **Embercap** was reportedly slain instantly by the divine being. However, eyewitnesses describe a bizarre temporal flux immediately following the event, with reality seemingly 'rewinding'. In the ensuing confusion, Embercap vanished. While most military sources have listed him as **Killed in Action**, his body was not recovered, and whispers of a miraculous, Manticore-assisted escape persist. The official stance is that he is presumed deceased.
            `,
            type: 'side_story'
        },
        {
            id: 'side_1',
            title: "Archie, The Toad, And The Sorceress: Vigilance Recaptured!",
            image: 'newspaper_xo_defeat.png',
            image_alt: "Chaos in the command center: a powerful female mage looks stunned, her magical staff now held by a small, determined toad-like creature. A centaur and a three-eyed rogue look on.",
            date: "OCTOBER 23, YEAR 42",
            author: "By W.A.H. Media Collective",
            content: `
In a stunning turn of events, the notorious airship _Vigilance_, recently seized by the rogue sorceress X.O., has been dramatically recaptured! Reports from inside the floating fortress confirm a chaotic confrontation involving the enigmatic three-eyed rogue, Archie Miser, the stoic Centaur Paladin, Markop Judi, and surprisingly, a courageous toad identified as Dan.

Sources close to the incident describe a desperate struggle within the _Vigilance_'s command center. The formidable X.O., known for her reality-bending arcane might, was reportedly overwhelmed not by brute force, but by an audacious maneuver orchestrated by the unlikely alliance. Eyewitnesses claim the diminutive toad, Dan, played a pivotal role, disarming the sorceress of her powerful staff at a critical moment, turning the tide of battle.

The recapturing of the _Vigilance_ is a significant blow to X.O.'s mysterious agenda and a major victory for those seeking to restore order, or at least a different kind of chaos. However, questions remain: What were X.O.'s ultimate goals? Where has she vanished to? And what does this unexpected heroism from a mere amphibian mean for the future of the Vigilance? More importantly, who is paying for all this damage? Our sources indicate Waluigi, the renowned Evil Genius, is already filing an insurance claim.
            `,
            type: 'side_story'
        },
        {
            id: 'side_2',
            title: "Princess Peach Dead: Mushroom Kingdom Plunges into Crisis",
            image: 'falling_figures.png', // Re-purposing an existing asset
            image_alt: "Three figures falling through a colorful, striped sky, one a sorcerer, another cloaked in wolf fur, and a small mushroom-shaped figure. Symbolizes chaos and peril.",
            date: "OCTOBER 25, YEAR 42",
            author: "Crisis Desk Report",
            content: `
In a tragic and shocking development, Princess Peach, beloved ruler of the Mushroom Kingdom, has been confirmed dead. Reports from the fractured kingdom indicate she was killed during a brief but devastating civil conflict, the culmination of years of escalating tensions and frequent incursions by Bowser's Koopa Troop.

While the precise circumstances of her death remain unclear amidst conflicting reports, many within the Protectorate point fingers squarely at Bowser. His relentless campaigns and constant destabilization of the region are widely seen as having created the powder keg that ultimately led to the civil war and the Princess's demise.

The Mushroom Kingdom is now in disarray, with a fractured Regency Council struggling to maintain order. This catastrophic loss marks a grim new chapter for the once-peaceful kingdom, leaving a power vacuum that many fear will only invite further conflict. Our thoughts and prayers are with the Kingdom's lawyers and accountants during this difficult time.
            `,
            type: 'side_story'
        }
    ],
    waluigi_corner: [
        {
            id: 'waluigi_1',
            title: "Waluigi's World Domination Tip #42!",
            content: `
WAH! You think you've seen chaos? You haven't seen anything until *I* get involved! All these little squabbles, these "factions," they're just puppets on my strings! The trick is to find what makes them tick, then **PULL THE STRING!**

The Empire? So stiff! Just give their engineers a *new* toy, one that's slightly unstable, and watch the sparks fly! The Mages' Guild? Full of bookworms. Just introduce them to something they can't *classify*, something truly **PARADOXICAL**, and they'll tear each other apart trying to understand it! And those whiny rebels? Give 'em a "common enemy" that's *actually* on your side, and boom! Instant distraction!

Remember, peace is boring. **CHAOS** is profitable! And nobody does chaos better than your favorite Evil Genius, Waluigi! WAH HA HA!
            `,
            type: 'waluigi_corner'
        }
    ],
    advert: [
        {
            id: 'advert_1',
            title: "Reliable Barrel Transport!",
            image: 'wario.png', // Assuming Wario asset will be created soon, or a barrel.
            image_alt: "A sturdy wooden barrel.",
            content: "Need to make a quick getaway? Or perhaps transport a valuable (or ghostly) cargo? **Bongo's Barrels** offers discreet and surprisingly sturdy barrel-based transport solutions. Fast, reliable, and almost impossible to track! (Not responsible for dimensional shifts or accidental resurrections.)",
            cta: "Call Now!",
            type: 'advert'
        },
        {
            id: 'advert_2',
            title: "Need a new Staff? Or two?",
            image: 'staff.png', // Assuming a staff asset will be created or used
            image_alt: "A gleaming magical staff.",
            content: "Lost your powerful arcane artifact in a scuffle? **Lario's Workshop** has a wide selection of ethically sourced (mostly) magical staves, wands, and other pointy bits! Trade-ins welcome, no questions asked. Special discounts for 'liberated' magical items!",
            cta: "Visit Lario's!",
            type: 'advert'
        },
        {
            id: 'advert_3',
            title: "Secure Your Secrets! (or steal others')",
            image: 'icon_dossier.png',
            image_alt: "An open folder icon.",
            content: "**The Shadowbrokers' Guild** offers top-tier information gathering and protection services. From secure data vaults to discreet asset acquisition, we ensure your secrets are safe... or that your enemies' secrets are not. Blackmail and counter-espionage a specialty.",
            cta: "Inquire Within",
            type: 'advert'
        },
        {
            id: 'advert_4',
            title: "Don't Be a Victim! Hire The Iron Fists!",
            image: 'faction_iron_fists.png',
            image_alt: "Iron Fists faction logo.",
            content: "Trouble with rivals? Need a 'package' delivered discreetly? **The Iron Fists** offer comprehensive protection and enforcement services. We'll make sure your 'competitors' understand who's boss. Discreet, effective, and always gets the job done. (Payment upfront.)",
            cta: "Contact Us",
            type: 'advert'
        }
    ]
};

// --- AUDIO ---
let audioContext;
const audioBuffers = {};

function initAudio() {
    if (audioContext) return;
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        loadSound('click.mp3');
    } catch (e) {
        console.warn('Web Audio API is not supported in this browser');
    }
}

async function loadSound(url) {
    if (!audioContext || audioBuffers[url]) return;
    try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = await audioContext.decodeAudioData(arrayBuffer);
        audioBuffers[url] = buffer;
    } catch (e) {
        console.error(`Failed to load sound: ${url}`, e);
    }
}

function playSound(url, volume = 0.7) {
    if (!audioContext || !audioBuffers[url]) {
        return;
    }
    const source = audioContext.createBufferSource();
    source.buffer = audioBuffers[url];
    const gainNode = audioContext.createGain();
    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
    source.connect(gainNode).connect(audioContext.destination);
    source.start(0);
}

// --- RENDERING ---

function getTodaysDate() {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date().toLocaleDateString('en-US', options).toUpperCase();
}

function renderArticle(article, container) {
    if (!container) return;

    let contentHTML = marked.parse(article.content || '');

    const articleClass = article.type === 'waluigi_corner' ? 'waluigi-corner' : (article.type === 'headline' ? 'headline' : '');
    
    container.className = `news-article ${articleClass}`;
    container.innerHTML = `
        <h3>${article.title}</h3>
        ${article.author ? `<div class="article-meta"><span>${article.date}</span> | <span>${article.author}</span></div>` : ''}
        ${article.image ? `<figure><img src="${article.image}" alt="${article.image_alt || article.title}"><figcaption>${article.image_alt || article.title}</figcaption></figure>` : ''}
        <div class="article-content">${contentHTML}</div>
    `;
}

function renderSideStory(article, container) {
    if (!container) return;

    const articleElement = document.createElement('div');
    articleElement.className = 'news-article';

    const contentHTML = marked.parse(article.content || '');

    articleElement.innerHTML = `
        <h3>${article.title}</h3>
        <div class="article-meta">
            <span>${article.date}</span> | <span>${article.author}</span>
        </div>
        ${article.image ? `<figure><img src="${article.image}" alt="${article.image_alt || article.title}"><figcaption>${article.image_alt || article.title}</figcaption></figure>` : ''}
        <div class="article-content">${contentHTML}</div>
    `;
    container.appendChild(articleElement);
}

function renderAdvert(advert, container) {
    if (!container) return;

    const advertElement = document.createElement('div');
    advertElement.className = 'advert-block';

    advertElement.innerHTML = `
        <h4>Advertisement</h4>
        ${advert.image ? `<img src="${advert.image}" alt="${advert.image_alt || advert.title}">` : ''}
        <h5>${advert.title}</h5>
        <p>${advert.content}</p>
        <a href="#" class="advert-cta">${advert.cta}</a>
    `;
    container.appendChild(advertElement);
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function renderNewspaper() {
    document.getElementById('newspaper-date').textContent = getTodaysDate();

    const headlineContainer = document.getElementById('headline-article');
    const sideStoriesContainer = document.getElementById('side-stories-container');
    const waluigiContainer = document.getElementById('waluigi-corner');
    const advertsContainer = document.getElementById('adverts-container');
    
    // Render Headline
    const headlineArticle = NEWS_ARTICLES.headline[0];
    if (headlineArticle) {
        renderArticle(headlineArticle, headlineContainer);
    }

    // Render Side Stories
    if (sideStoriesContainer) {
        sideStoriesContainer.innerHTML = ''; // Clear previous
        const shuffledSideStories = shuffleArray([...NEWS_ARTICLES.side_story]);
        const numberOfSideStories = Math.min(shuffledSideStories.length, 3); 
        for (let i = 0; i < numberOfSideStories; i++) {
            renderSideStory(shuffledSideStories[i], sideStoriesContainer);
        }
    }

    // Render Waluigi's Corner
    const waluigiCornerArticle = NEWS_ARTICLES.waluigi_corner[0];
    if (waluigiCornerArticle) {
        renderArticle(waluigiCornerArticle, waluigiContainer);
    }

    // Render Adverts
    if (advertsContainer) {
        advertsContainer.innerHTML = ''; // Clear previous
        const shuffledAdverts = shuffleArray([...NEWS_ARTICLES.advert]);
        const numberOfAdverts = Math.min(shuffledAdverts.length, 4); 
        for (let i = 0; i < numberOfAdverts; i++) {
            renderAdvert(shuffledAdverts[i], advertsContainer);
        }
    }
}

// --- EVENT LISTENERS ---
function setupEventListeners() {
    document.body.addEventListener('click', () => initAudio(), { once: true });

    document.getElementById('adverts-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('advert-cta')) {
            e.preventDefault();
            playSound('click.mp3', 0.6);
            alert("WAH! You clicked an ad! Now go buy Waluigi's goods!");
        }
    });
}

// --- INITIALIZATION ---
function main() {
    renderNewspaper();
    setupEventListeners();
}

main();